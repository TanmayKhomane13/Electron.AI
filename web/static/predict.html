<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demand Load Forecast - Electron.AI</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        vega: {
                            black: '#0a0a0b',
                            dark: '#121214',
                            card: 'rgba(24, 24, 27, 0.6)',
                            border: 'rgba(255, 255, 255, 0.08)',
                            yellow: '#eab308',
                            yellowGlow: 'rgba(234, 179, 8, 0.25)'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #0a0a0b;
            color: #e4e4e7;
            /* Subtle animated background mesh/gradient */
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(234, 179, 8, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 85% 30%, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
            min-height: 100vh;
        }
        
        /* Glassmorphism utilities */
        .glass-panel {
            background: var(--tw-colors-vega-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--tw-colors-vega-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-glow {
            box-shadow: 0 0 20px var(--tw-colors-vega-yellowGlow);
            border-color: rgba(234, 179, 8, 0.3);
        }

        /* Custom Scrollbar for table */
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: #121214; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #eab308; }

        /* Loader Animation */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-bottom-color: #eab308;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Transformer Card Styles */
        .transformer-high { border-left: 4px solid #ef4444; background: rgba(239,68,68,0.08); }
        .transformer-medium { border-left: 4px solid #f59e0b; background: rgba(245,158,11,0.08); }
        .transformer-low { border-left: 4px solid #10b981; background: rgba(16,185,129,0.08); }
    </style>
</head>
<body class="antialiased selection:bg-yellow-500 selection:text-black">

    <!-- Ambient Top Glow -->
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[600px] h-[300px] bg-yellow-500/10 rounded-full blur-[100px] pointer-events-none z-0"></div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-10">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-zinc-400 font-medium tracking-widest text-sm uppercase">Electron.AI</span>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Load Forecast</h1>
            </div>
            <div class="text-sm text-zinc-500 flex items-center gap-4">
                <div id="liveClock" class="text-zinc-300 font-medium tracking-wide">
                    --:--:--
                </div>
                <div class="flex items-center gap-2">
                    <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                    </span>
                    Live System Ready
                </div>
            </div>
        </header>

        <!-- CONTROLS -->
        <section class="glass-panel rounded-2xl p-6 mb-8 transition-all duration-300 hover:border-zinc-700">
            <div class="flex flex-col sm:flex-row items-end gap-4">
                <div class="w-full sm:w-64">
                    <label class="block text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-2">Forecast Horizon</label>
                    <div class="relative">
                        <select id="horizonSelect" class="w-full appearance-none bg-vega-dark border border-zinc-800 text-white rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500/50 focus:border-yellow-500 transition-all cursor-pointer">
                            <option value="" disabled selected>Select hours ahead...</option>
                            <!-- Options injected via JS -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-zinc-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
                <button id="predictBtn" class="w-full sm:w-auto px-8 py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-semibold rounded-xl shadow-[0_0_15px_rgba(234,179,8,0.2)] hover:shadow-[0_0_25px_rgba(234,179,8,0.4)] transition-all duration-300 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Run Prediction
                </button>
            </div>
        </section>

        <!-- LOADER -->
        <div id="loading" class="hidden flex-col items-center justify-center py-20">
            <span class="loader w-12 h-12 mb-4"></span>
            <p class="text-zinc-400 font-medium animate-pulse">Running ML Models...</p>
        </div>

        <!-- PEAK LOAD CARD -->
        <div id="peakCard" class="glass-panel rounded-2xl p-6 transition-all duration-500 border border-zinc-800 hidden">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-wider text-zinc-400 mb-2">
                        Peak Load in Selected Horizon
                    </p>
                    <h2 id="peakValue" class="text-3xl font-bold tracking-tight text-white">
                        --
                    </h2>
                </div>
                <div id="peakStatus"
                    class="text-sm font-semibold px-4 py-2 rounded-full border">
                    --
                </div>
            </div>
        </div>

        <!-- RESULTS SECTION -->
        <div id="resultsSection" class="hidden space-y-8 animate-fade-in">

            <!-- CHART -->
            <div class="glass-panel glass-glow rounded-3xl p-6 lg:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-white">Projected Demand Curve</h3>
                    <span class="text-xs font-medium px-3 py-1 bg-yellow-500/10 text-yellow-500 border border-yellow-500/20 rounded-full">MW</span>
                </div>
                <div class="relative h-[300px] md:h-[400px] w-full">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <!-- DATA GRID -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- CARDS -->
                <div class="lg:col-span-2">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        Hourly Breakdown
                    </h3>
                    <div id="forecastCards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[400px] overflow-y-auto pr-2 pb-2">
                        <!-- Cards Injected Here -->
                    </div>
                </div>

                <!-- TABLE -->
                <div class="lg:col-span-1">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Data Summary
                    </h3>
                    <div class="glass-panel rounded-2xl overflow-hidden flex flex-col h-[400px]">
                        <div class="overflow-y-auto flex-1">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-zinc-400 uppercase bg-zinc-900/80 sticky top-0 backdrop-blur-md z-10">
                                    <tr>
                                        <th class="px-4 py-4 font-semibold">Time</th>
                                        <th class="px-4 py-4 font-semibold text-right">Load (MW)</th>
                                        <th class="px-4 py-4 font-semibold text-right">Env</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTable" class="divide-y divide-zinc-800/50">
                                    <!-- Table Rows Injected Here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <!-- TRANSFORMER MONITOR SECTION -->
            <div id="transformerSection" class="glass-panel rounded-3xl p-6 lg:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 9a9 9 0 1113.1 6.36L24 9c0-5.05-3.41-9.28-8-10.5v2.07A7 7 0 0016 9c0 4.42-4.03 8-9 8a7.48 7.48 0 01-1.23-.1L2 21v-3a9 9 0 010-9z"></path></svg>
                        Transformer Status (Hyper-local)
                    </h3>
                    <div id="transformerOverallRisk" class="text-xs font-semibold px-3 py-1 rounded-full border hidden">
                        --
                    </div>
                </div>
                <div id="transformerLoading" class="flex items-center justify-center py-12 text-zinc-500">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading Mumbai substations...
                </div>
                <div id="transformerGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 hidden"></div>
            </div>

        </div>
    </div>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<script>
    function updateClock() {
        const now = new Date();
        const formatted = now.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        const clock = document.getElementById("liveClock");
        if (clock) {
            clock.textContent = formatted;
        }
    }

    updateClock();
    setInterval(updateClock, 1000);
    
    const select = document.getElementById("horizonSelect");
    const btn = document.getElementById("predictBtn");
    const results = document.getElementById("resultsSection");
    const cardsContainer = document.getElementById("forecastCards");
    const tableBody = document.getElementById("summaryTable");
    const loading = document.getElementById("loading");

    let chartInstance = null;

    // Populate dropdown 1-24
    for (let i = 1; i <= 24; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `+${i} Hour${i > 1 ? 's' : ''} Ahead`;
        select.appendChild(option);
    }

    // Set defaults for Chart.js to match dark theme
    Chart.defaults.color = '#a1a1aa';
    Chart.defaults.font.family = "'Inter', sans-serif";

    // Simulate API Call for demonstration (since real API won't work in this static preview)
    async function fetchMockData(horizon) {
        return new Promise(resolve => {
            setTimeout(() => {
                const forecast = {};
                const temps = [];
                const hums = [];
                let baseLoad = 2800 + Math.random() * 200; // Baseline Mumbai Load MW
                
                for(let i=1; i<=horizon; i++) {
                    // Create realistic curve
                    const timeVariation = Math.sin((i / 24) * Math.PI * 2) * 300; 
                    forecast[`load_lag_t+${i}`] = Math.round(baseLoad + timeVariation + (Math.random() * 50 - 25));
                    temps.push(Math.round(28 + Math.random() * 5));
                    hums.push(Math.round(65 + Math.random() * 15));
                }
                resolve({ success: true, horizon, forecast, weather: { temps, hums } });
            }, 1200); // Fake network delay for effect
        });
    }

    btn.addEventListener("click", async () => {
        const horizon = parseInt(select.value);
        if (!horizon) return;

        // UI State: Loading
        loading.style.display = "flex";
        results.style.display = "none";
        btn.disabled = true;
        btn.classList.add('opacity-70', 'cursor-not-allowed');

        try {
            // Attempt real fetch, fallback to mock if it fails
            let data;
            try {
                const response = await fetch("/api/forecast", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ horizon })
                });
                if(!response.ok) throw new Error("API Route missing");
                data = await response.json();
            } catch (err) {
                console.warn("Real API failed, falling back to realistic mock data for preview.");
                data = await fetchMockData(horizon);
            }

            if (!data.success) throw new Error("Prediction failed");
            renderResults(data);
            await loadTransformers(horizon); // Load transformers after main forecast

        } catch (err) {
            alert("Error generating forecast. Please check console.");
        } finally {
            // UI State: Complete
            loading.style.display = "none";
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
        }
    });

    async function loadTransformers(horizon) {
        const transformerLoading = document.getElementById('transformerLoading');
        const transformerGrid = document.getElementById('transformerGrid');
        const transformerOverallRisk = document.getElementById('transformerOverallRisk');

        transformerLoading.style.display = 'flex';
        transformerGrid.style.display = 'none';
        transformerOverallRisk.classList.add('hidden');

        try {
            // Try real transformer API first
            let transformerData;
            try {
                const response = await fetch(`/api/transformers/${horizon}`);
                if (response.ok) {
                    transformerData = await response.json();
                } else {
                    throw new Error('API not ready');
                }
            } catch (err) {
                console.warn('Transformer API unavailable, using mock data');
                // Mock transformer data matching your backend structure
                transformerData = {
                    success: true,
                    horizon: horizon,
                    overall_risk: 'medium',
                    transformers: [
                        {
                            name: 'T1-Bandra', location: '19.0671¬∞N 72.8657¬∞E', capacity: 2000, current_load: 1400, 
                            transformer_peak: 2385.2, first_hour_temp: 34.8, overload_pct: 4.2, risk: 'low',
                            recommendations: ['Continue monitoring', 'Daily log']
                        },
                        {
                            name: 'T2-Dadar', location: '19.0190¬∞N 72.8420¬∞E', capacity: 1800, current_load: 1650, 
                            transformer_peak: 1923.7, first_hour_temp: 34.2, overload_pct: 6.9, risk: 'low',
                            recommendations: ['Continue monitoring', 'Daily log']
                        },
                        {
                            name: 'T3-Andheri', location: '19.1137¬∞N 72.8632¬∞E', capacity: 2100, current_load: 1750, 
                            transformer_peak: 2356.4, first_hour_temp: 35.1, overload_pct: 7.1, risk: 'medium',
                            recommendations: ['Balance feeder loads', 'Aux cooling START', 'Alert substation team']
                        },
                        {
                            name: 'T4-Kurla', location: '19.0760¬∞N 72.8774¬∞E', capacity: 1300, current_load: 850, 
                            transformer_peak: 2142.8, first_hour_temp: 34.5, overload_pct: 7.1, risk: 'medium',
                            recommendations: ['Balance feeder loads', 'Aux cooling START', 'Alert substation team']
                        }
                    ]
                };
            }

            if (transformerData.success) {
                transformerGrid.innerHTML = transformerData.transformers.map(t => `
                    <div class="glass-panel rounded-xl p-5 hover:bg-zinc-800/40 transition-all transformer-${t.risk}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 flex items-center justify-center border-2 border-yellow-500/30">
                                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-bold text-white text-lg">${t.name}</div>
                                    <div class="text-xs text-zinc-400">${t.location}</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4 text-sm">
                            <div class="text-right">
                                <div class="text-2xl font-bold text-yellow-500">${t.current_load}</div>
                                <div class="text-zinc-500">Current</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-yellow-500">${t.transformer_peak}</div>
                                <div class="text-zinc-500">Peak</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">${t.capacity}</div>
                                <div class="text-zinc-500">Capacity</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-red-400">+${t.overload_pct}%</div>
                                <div class="text-zinc-500">Overload</div>
                            </div>
                        </div>
                        <div class="text-xs mb-3">
                            <span class="text-zinc-400">üå°Ô∏è ${t.first_hour_temp}¬∞C</span> 
                            <span class="ml-2 px-2 py-1 bg-zinc-800 text-zinc-300 rounded-full text-xs font-semibold">${t.risk.toUpperCase()}</span>
                        </div>
                        <div class="space-y-1">
                            ${t.recommendations.map(rec => `<div class="text-xs text-zinc-300">${rec}</div>`).join('')}
                        </div>
                    </div>
                `).join('');

                transformerOverallRisk.textContent = `Overall Risk: ${transformerData.overall_risk.toUpperCase()}`;
                transformerOverallRisk.className = `text-sm font-semibold px-4 py-2 rounded-full border transformer-${transformerData.overall_risk}`;
                transformerOverallRisk.classList.remove('hidden');

                transformerLoading.style.display = 'none';
                transformerGrid.style.display = 'grid';
            }
        } catch (err) {
            transformerLoading.innerHTML = '<div class="text-zinc-400 text-sm">Transformer data unavailable</div>';
        }
    }

    function renderResults(data) {
        const horizon = data.horizon;
        const forecast = data.forecast;
        const temps = data.weather.temps;
        const hums = data.weather.hums;

        results.style.display = "block";
        cardsContainer.innerHTML = "";
        tableBody.innerHTML = "";

        const labels = [];
        const loads = [];

        const now = new Date();

        for (let h = 1; h <= horizon; h++) {
            const load = forecast[`load_lag_t+${h}`];
            const temp = temps[h-1] ?? temps[temps.length-1];
            const hum = hums[h-1] ?? hums[hums.length-1];

            // Calculate future hour
            const futureTime = new Date(now);
            futureTime.setHours(now.getHours() + h);

            const hourLabel = futureTime.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            labels.push(hourLabel);
            loads.push(load);

            // RENDER CARD
            cardsContainer.innerHTML += `
            <div class="glass-panel rounded-xl p-5 hover:bg-zinc-800/40 transition-colors border border-transparent hover:border-zinc-700">
                <div class="flex justify-between items-start mb-3">
                    <span class="text-xs font-bold text-zinc-500 bg-zinc-900 px-2 py-1 rounded">${hourLabel}</span>
                    <span class="text-yellow-500 font-bold text-lg tracking-tight">${load.toLocaleString()} <span class="text-xs text-yellow-600">MW</span></span>
                </div>
                <div class="flex items-center gap-4 text-xs text-zinc-400 mt-4">
                    <div class="flex items-center gap-1">
                        ${temp}¬∞C
                    </div>
                    <div class="flex items-center gap-1">
                        ${hum}%
                    </div>
                </div>
            </div>`;

            // RENDER TABLE ROW
            tableBody.innerHTML += `
            <tr class="hover:bg-zinc-800/30 transition-colors">
                <td class="px-4 py-3 font-medium text-zinc-300 whitespace-nowrap">${hourLabel}</td>
                <td class="px-4 py-3 text-right">
                    <span class="text-yellow-500 font-semibold">${load.toLocaleString()}</span>
                </td>
                <td class="px-4 py-3 text-right text-xs text-zinc-500">
                    ${temp}¬∞C / ${hum}%
                </td>
            </tr>`;
        }

        renderChart(labels, loads);
    }

    function renderChart(labels, loads) {
        const ctx = document.getElementById("forecastChart").getContext('2d');

        if (chartInstance) {
            chartInstance.destroy();
        }

        const maxLoad = Math.max(...loads);
        const maxIndex = loads.indexOf(maxLoad);

        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(234, 179, 8, 0.4)');
        gradient.addColorStop(1, 'rgba(234, 179, 8, 0.0)');

        // Animation timing
        let startTime = Date.now();

        chartInstance = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Predicted Load (MW)",
                    data: loads,
                    borderColor: "#eab308",
                    backgroundColor: gradient,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: (ctx) => ctx.dataIndex === maxIndex ? 5 : 3,
                    pointBackgroundColor: (ctx) => ctx.dataIndex === maxIndex ? "#ef4444" : "#0a0a0b",
                    pointBorderColor: "#eab308",
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                },
                animation: { duration: 0 }
            },
            plugins: [{
                id: 'peakRippleEffect',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    const meta = chart.getDatasetMeta(0);
                    const point = meta.data[maxIndex];

                    if (!point) return;

                    ctx.save();
                    ctx.translate(point.x, point.y);
                    
                    const elapsed = (Date.now() - startTime) * 0.003; // Speed control
                    const rippleSpeed = 0.8;

                    // Multiple rippling rings (3 layers)
                    for (let i = 0; i < 3; i++) {
                        const rippleAge = (elapsed + i * rippleSpeed) % (Math.PI * 2);
                        const radius = (rippleAge / (Math.PI * 2)) * 25 + 4; // Max 29px
                        const opacity = Math.max(0, 1 - (rippleAge / (Math.PI * 2)) * 2); // Fade out

                        // Rippling ring
                        ctx.beginPath();
                        ctx.arc(0, 0, radius, 0, Math.PI * 2);
                        
                        // Wave thickness + distortion
                        const wave = Math.sin(rippleAge * 8 + i) * 0.5;
                        ctx.lineWidth = 2 + wave * 1;
                        
                        ctx.strokeStyle = `rgba(239, 68, 68, ${opacity * 0.6})`;
                        ctx.shadowColor = `rgba(239, 68, 68, ${opacity * 0.8})`;
                        ctx.shadowBlur = 15 + radius * 0.3;
                        ctx.stroke();
                    }

                    // Core glowing dot
                    ctx.shadowColor = "rgba(239, 68, 68, 0.9)";
                    ctx.shadowBlur = 18;
                    ctx.beginPath();
                    ctx.arc(0, 0, 5, 0, Math.PI * 2);
                    ctx.fillStyle = "#ef4444";
                    ctx.fill();

                    ctx.restore();
                }
            }]
        });

        // Continuous ripple animation
        function animate() {
            if (chartInstance) {
                chartInstance.resize();
            }
            requestAnimationFrame(animate);
        }
        animate();
    }
</script>

</body>
</html>